cmake_minimum_required(VERSION 3.14)

project(cmake-init-llvm-forkTests LANGUAGES CXX)

include(../cmake/project-is-top-level.cmake)
include(../cmake/folders.cmake)
include(../cmake/windows-set-path.cmake)

if(PROJECT_IS_TOP_LEVEL)
  include(GNUInstallDirs)
  find_package(cmake-init-llvm-fork REQUIRED)
  enable_testing()
endif()

# Add test executables with assertions
add_executable(cmake-init-llvm-fork_test source/cmake-init-llvm-fork_test.cpp)
target_link_libraries(cmake-init-llvm-fork_test PRIVATE cmake-init-llvm-fork::cmake-init-llvm-fork)
target_compile_features(cmake-init-llvm-fork_test PRIVATE cxx_std_17)

add_test(NAME cmake-init-llvm-fork_test COMMAND cmake-init-llvm-fork_test)
windows_set_path(cmake-init-llvm-fork_test cmake-init-llvm-fork::cmake-init-llvm-fork)

# Add test tool executables for LIT
add_executable(cmake-init-llvm-fork_tool_test tool-src/cmake-init-llvm-fork_tool_test.cpp)
target_link_libraries(cmake-init-llvm-fork_tool_test PRIVATE cmake-init-llvm-fork::cmake-init-llvm-fork)
target_compile_features(cmake-init-llvm-fork_tool_test PRIVATE cxx_std_17)

# Setup LLVM's own LIT testing
find_package(LLVM 13 CONFIG REQUIRED)
set(llvm_lit "${LLVM_DEFAULT_EXTERNAL_LIT}")
if(NOT EXISTS "${llvm_lit}")
  find_program(llvm_lit NAMES llvm-lit lit DOC "LLVM LIT testing tool")
endif()

# Setup replacement variables
set(site_cfg_input "${CMAKE_CURRENT_SOURCE_DIR}/lit.site.cfg.py.in")
set(site_cfg_in_header  "## Autogenerated from ${site_cfg_input}\n## Do not edit!")
set(tool_test_exe $<TARGET_FILE:cmake-init-llvm-fork_tool_test>)
set(pass_lib)
if(NOT WIN32)
  set(pass_lib $<TARGET_FILE:cmake-init-llvm-fork::cmake-init-llvm-forkPass>)
endif()

# Replace CMake variables
configure_file("${site_cfg_input}"
  "${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg.py.in" @ONLY
)
# Replace generator expressions
file(GENERATE
  OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg.py"
  INPUT "${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg.py.in"
)

# Add LIT tests to CTest
# NOTE: This isn't the most effective when running ctest in parallel because
# LIT is already parallelized, so there could be resource contention.
add_test(
  NAME cmake-init-llvm-fork_test-lit
  COMMAND "${llvm_lit}" ${LLVM_LIT_ARGS} lit
)

add_folders(Test)
